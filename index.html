<!DOCTYPE html>
<html lang="en">

  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Indoor Humidity Calculator</title>
    <script src="https://cdn.tailwindcss.com"></script>
  </head>

  <body class="bg-gray-100 min-h-screen p-8">
    <div class="max-w-4xl mx-auto">

      <!-- Sliders -->
      <div class="grid grid-cols-2 gap-6 mb-8">

        <!-- Outdoor Temperature -->
        <div>
          <div class="bg-white rounded-lg p-6 shadow-md">
            <label class="block text-sm font-medium mb-2">Outdoor Temp</label>
            <div class="text-3xl font-bold mb-4 text-center" id="outdoorTempValue">15.0°C</div>
            <input type="range" id="outdoorTemp" min="-20" max="40" value="15" step="0.5"
              class="w-full h-4 rounded-full appearance-none cursor-pointer"
              style="background: linear-gradient(to right, #3b82f6, #f97316);">
          </div>
        </div>

        <!-- Outdoor Humidity -->
        <div>
          <div class="bg-white rounded-lg p-6 shadow-md">
            <label class="block text-sm font-medium mb-2">Outdoor Humidity</label>
            <div class="text-3xl font-bold mb-4 text-center" id="outdoorHumidityValue">50%</div>
            <input type="range" id="outdoorHumidity" min="0" max="100" value="50" step="1"
              class="w-full h-4 rounded-lg appearance-none cursor-pointer"
              style="background: linear-gradient(to right, #bfdbfe, #1e40af);">
          </div>
        </div>

        <!-- Indoor Temperature -->
        <div>
          <div class="bg-white rounded-lg p-6 shadow-md">
            <label class="block text-sm font-medium mb-2">Indoor Temp</label>
            <div class="text-3xl font-bold mb-4 text-center" id="indoorTempValue">20.0°C</div>
            <input type="range" id="indoorTemp" min="10" max="30" value="20" step="0.5"
              class="w-full h-4 rounded-lg appearance-none cursor-pointer"
              style="background: linear-gradient(to right, #3b82f6, #f97316);">
          </div>
        </div>

        <!-- Indoor Humidity (Output) -->
        <div>
          <div class="bg-white rounded-lg p-6 shadow-md border-2 border-purple-500">
            <label class="block text-sm font-medium mb-2">Indoor Humidity</label>
            <div class="text-3xl font-bold mb-4 text-center text-purple-700" id="indoorHumidityValue">--
            </div>
            <div class="w-full h-4 rounded-lg" id="indoorHumidityBar"
              style="background: linear-gradient(to right, #bfdbfe, #1e40af);"></div>
          </div>
        </div>
      </div>

      <!-- Fill Location Button -->
      <div class="bg-white rounded-lg p-6 shadow-md">
        <button id="fillLocation" class="w-full py-3 bg-blue-600 text-white font-medium rounded-lg hover:bg-blue-700">
          Fill from Current Location
        </button>

        <div id="status" class="mt-4 space-y-2 text-sm"></div>
      </div>

    </div>

    <script>
      const outdoorTempSlider = document.getElementById('outdoorTemp');
      const outdoorHumiditySlider = document.getElementById('outdoorHumidity');
      const indoorTempSlider = document.getElementById('indoorTemp');

      const outdoorTempValue = document.getElementById('outdoorTempValue');
      const outdoorHumidityValue = document.getElementById('outdoorHumidityValue');
      const indoorTempValue = document.getElementById('indoorTempValue');
      const indoorHumidityValue = document.getElementById('indoorHumidityValue');
      const indoorHumidityBar = document.getElementById('indoorHumidityBar');

      function calculateIndoorHumidity() {
        const outTemp = parseFloat(outdoorTempSlider.value);
        const outHum = parseFloat(outdoorHumiditySlider.value);
        const inTemp = parseFloat(indoorTempSlider.value);

        // Magnus formula for dew point
        const a = 17.27;
        const b = 237.7;
        const alpha = ((a * outTemp) / (b + outTemp)) + Math.log(outHum / 100);
        const dewPoint = (b * alpha) / (a - alpha);

        // Calculate indoor RH
        const indoorAlpha = (a * inTemp) / (b + inTemp);
        const dewPointAlpha = (a * dewPoint) / (b + dewPoint);
        const indoorRH = Math.max(0, Math.min(100, 100 * Math.exp(dewPointAlpha - indoorAlpha)));

        indoorHumidityValue.textContent = Math.round(indoorRH) + '%';

        // Update color intensity
        const intensity = indoorRH / 100;
        const lightBlue = [191, 219, 254]; // #bfdbfe
        const darkBlue = [30, 64, 175];    // #1e40af
        const r = Math.round(lightBlue[0] + (darkBlue[0] - lightBlue[0]) * intensity);
        const g = Math.round(lightBlue[1] + (darkBlue[1] - lightBlue[1]) * intensity);
        const bl = Math.round(lightBlue[2] + (darkBlue[2] - lightBlue[2]) * intensity);
        indoorHumidityBar.style.background = `rgb(${r}, ${g}, ${bl})`;
      }

      outdoorTempSlider.addEventListener('input', () => {
        outdoorTempValue.textContent = parseFloat(outdoorTempSlider.value).toFixed(1) + '°C';
        calculateIndoorHumidity();
      });

      outdoorHumiditySlider.addEventListener('input', () => {
        outdoorHumidityValue.textContent = outdoorHumiditySlider.value + '%';
        calculateIndoorHumidity();
      });

      indoorTempSlider.addEventListener('input', () => {
        indoorTempValue.textContent = parseFloat(indoorTempSlider.value).toFixed(1) + '°C';
        calculateIndoorHumidity();
      });

      // Fill from location
      document.getElementById('fillLocation').addEventListener('click', async () => {
        const statusDiv = document.getElementById('status');
        statusDiv.innerHTML = '';

        function addStatus(message, status) {
          const div = document.createElement('div');
          div.className = status === 'loading' ? 'text-gray-600' :
            status === 'success' ? 'text-green-600 font-medium' :
              'text-red-600 font-medium';
          div.textContent = message;
          statusDiv.appendChild(div);
        }

        addStatus('Getting location...', 'loading');

        if (!navigator.geolocation) {
          addStatus('Geolocation not supported', 'error');
          return;
        }

        navigator.geolocation.getCurrentPosition(async (position) => {
          const lat = position.coords.latitude;
          const lon = position.coords.longitude;
          addStatus(`Location acquired: ${lat.toFixed(4)}, ${lon.toFixed(4)}`, 'success');
          addStatus(`Accuracy: ±${position.coords.accuracy.toFixed(0)}m`, 'success');

          addStatus('Fetching weather data...', 'loading');
          const apiUrl = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=temperature_2m,relative_humidity_2m&timezone=auto`;
          addStatus(`API URL: ${apiUrl}`, 'loading');

          try {
            const response = await fetch(apiUrl);

            if (!response.ok) {
              throw new Error(`API returned ${response.status}`);
            }

            const data = await response.json();
            addStatus('Weather data retrieved', 'success');
            addStatus(`Raw data: ${JSON.stringify(data.current)}`, 'success');
            addStatus(`Timezone: ${data.timezone}`, 'success');
            addStatus(`Temperature: ${data.current.temperature_2m}°C`, 'success');
            addStatus(`Humidity: ${data.current.relative_humidity_2m}%`, 'success');

            outdoorTempSlider.value = data.current.temperature_2m;
            outdoorHumiditySlider.value = data.current.relative_humidity_2m;
            outdoorTempValue.textContent = data.current.temperature_2m.toFixed(1) + '°C';
            outdoorHumidityValue.textContent = data.current.relative_humidity_2m + '%';

            calculateIndoorHumidity();

          } catch (error) {
            addStatus('Failed to fetch weather data: ' + error.message, 'error');
          }

        }, (error) => {
          addStatus('Location error: ' + error.message, 'error');
        });
      });

      // Initial calculation
      calculateIndoorHumidity();
    </script>

    <style>
      input[type="range"]::-webkit-slider-thumb {
        appearance: none;
        width: 24px;
        height: 24px;
        border-radius: 50%;
        background: white;
        cursor: pointer;
        border: 3px solid #6366f1;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
      }

      input[type="range"]::-moz-range-thumb {
        width: 24px;
        height: 24px;
        border-radius: 50%;
        background: white;
        cursor: pointer;
        border: 3px solid #6366f1;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
      }
    </style>
  </body>

</html>